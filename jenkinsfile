pipeline {
    agent any

//  def appName = 'my-app'
//  def feSvcName = "${appName}-frontend"
 // def imageTag = "rgaddamanugu/${appName}:1.16"

  stages {
     stage('Git checkout') {
            steps {
                echo 'Fetching code from Git...'
                git url: 'https://github.com/rgaddama/myapp.git'
                checkout scm
            }
        }

     stage ('Build image') {
            steps {
               sh("docker build -t my-app .")
           }
        }

     stage ('Tag image') {
            steps {
               sh("docker tag my-app rgaddamanugu/my-app:0.1.20")
           }
        }

     stage ('Push image to registry') {
            steps {
               sh("docker push rgaddamanugu/my-app:0.1.20")
           }
        }

     stage ('Kuberenetes Services up') {
            steps { 
              sh("sed -i.bak 's#rgaddamanugu/my-app:0.1.19#rgaddamanugu/my-app:0.1.20#' ./k8s/dev/*.yaml")
              sh("kubectl --namespace=default apply -f k8s/services/")
              sh("kubectl --namespace=default apply -f k8s/dev/")
              sh("echo http://`kubectl --namespace=default get service/my-app-frontend`")
          }
        }
  } 
}    
